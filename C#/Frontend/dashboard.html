<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sinout - Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        background: var(--bg-secondary);
      }

      .dashboard {
        padding: 32px 24px;
        max-width: 1600px;
        margin: 0 auto;
      }

      .dashboard-header {
        margin-bottom: 32px;
      }

      .dashboard-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .dashboard-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
      }

      /* Main Grid Layout */
      .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 24px;
        margin-bottom: 24px;
      }

      /* Camera Container - Modern Glass */
      .camera-card {
        background: white;
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow-sm);
      }

      .camera-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .camera-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border-radius: 999px;
        font-size: 12px;
        font-weight: 500;
      }

      .status-dot {
        width: 6px;
        height: 6px;
        background: currentColor;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .video-container {
        position: relative;
        background: var(--gray-900);
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 16/9;
        margin-bottom: 16px;
      }

      #videoElement {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        font-size: 14px;
      }

      .camera-controls {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }

      .auto-capture-toggle {
        margin-top: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border: 1px solid var(--border-secondary);
      }

      .toggle-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .toggle-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
        background: var(--gray-300);
        border-radius: 999px;
        cursor: pointer;
        transition: background var(--transition-base);
      }

      .toggle-switch.active {
        background: var(--primary);
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: transform var(--transition-base);
      }

      .toggle-switch.active::after {
        transform: translateX(24px);
      }

      .interval-selector {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-secondary);
      }

      .interval-selector label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
      }

      .interval-selector select {
        flex: 1;
        height: 36px;
        padding: 0 36px 0 12px;
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        background: white;
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all var(--transition-base);
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%238b5cf6' d='M1.41 0L6 4.58 10.59 0 12 1.41l-6 6-6-6z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 10px;
        font-family: "Inter", sans-serif;
        font-weight: 500;
      }

      .interval-selector select:hover {
        border-color: var(--gray-300);
      }

      .interval-selector select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      /* Model Selector - Same style as interval selector */
      .model-selector-container {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-secondary);
      }

      .model-selector {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .model-selector label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
      }

      .model-selector select {
        flex: 1;
        height: 36px;
        padding: 0 36px 0 12px;
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-md);
        background: white;
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all var(--transition-base);
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%238b5cf6' d='M1.41 0L6 4.58 10.59 0 12 1.41l-6 6-6-6z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 10px;
        font-family: "Inter", sans-serif;
        font-weight: 500;
      }

      .model-selector select:hover {
        border-color: var(--gray-300);
      }

      .model-selector select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      .toggle-description {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
      }

      /* Results Sidebar */
      .results-card {
        background: white;
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow-sm);
        max-height: 600px;
        overflow-y: auto;
      }

      .results-header {
        margin-bottom: 20px;
      }

      .results-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .results-subtitle {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .result-item {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        margin-bottom: 12px;
        border: 1px solid var(--border-secondary);
        transition: all 200ms ease;
      }

      .result-item:hover {
        border-color: var(--border-primary);
        transform: translateY(-1px);
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .result-emotion {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .result-percentage {
        font-size: 20px;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .result-message {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .result-message.alert {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
        padding: 8px 12px;
        border-radius: 8px;
        margin-top: 8px;
      }

      .result-message.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        padding: 8px 12px;
        border-radius: 8px;
        margin-top: 8px;
      }

      /* User Info Card */
      .user-card {
        background: white;
        border: 1px solid var(--border-primary);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow-sm);
      }

      .user-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
      }

      .user-avatar {
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        font-weight: 700;
      }

      .user-info h3 {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .user-info p {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .user-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .stat-item {
        text-align: center;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 48px 24px;
        color: var(--text-tertiary);
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .camera-controls {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 768px) {
        .dashboard {
          padding: 16px;
        }

        .user-stats {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <style>
      /* Rule Message */
      .rule-message-container {
        margin-bottom: 20px;
      }

      .rule-message-box {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .rule-message-icon {
        font-size: 20px;
        opacity: 0.8;
        flex-shrink: 0;
      }

      .rule-message-content {
        flex: 1;
      }

      .rule-message-label {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
      }

      .rule-message-text {
        font-size: 14px;
        color: #334155;
        line-height: 1.5;
        font-weight: 500;
      }
    </style>
  </head>

  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="navbar-container">
        <a href="index.html" class="navbar-logo">
          <div class="navbar-logo-icon">S</div>
          <span>Sinout</span>
        </a>
        <ul class="navbar-menu">
          <li><a href="index.html" class="navbar-link">In√≠cio</a></li>
          <li>
            <a href="dashboard.html" class="navbar-link active">Dashboard</a>
          </li>
          <li><a href="history.html" class="navbar-link">Hist√≥rico</a></li>
          <li><a href="rules.html" class="navbar-link">Regras</a></li>
          <li><a href="#" class="navbar-link" id="logoutBtn">Sair</a></li>
        </ul>
      </div>
    </nav>

    <!-- Dashboard Content -->
    <main class="dashboard">
      <div class="dashboard-header">
        <h1 class="dashboard-title">Dashboard</h1>
        <p class="dashboard-subtitle">
          Monitoramento em tempo real das emo√ß√µes
        </p>
      </div>

      <!-- Main Grid -->
      <div class="dashboard-grid">
        <!-- Camera Section -->
        <div class="camera-card">
          <div class="camera-header">
            <h2 class="camera-title">C√¢mera</h2>
            <div class="status-badge">
              <span class="status-dot"></span>
              <span>Ativo</span>
            </div>
          </div>

          <div class="video-container">
            <video id="videoElement" autoplay playsinline></video>
            <div class="video-overlay" id="videoOverlay">
              Clique em "Iniciar C√¢mera" para come√ßar
            </div>
          </div>

          <div class="camera-controls">
            <button class="btn btn-primary" id="startCameraBtn">
              Iniciar C√¢mera
            </button>
            <button class="btn btn-secondary" id="captureFaceBtn" disabled>
              Capturar
            </button>
            <button class="btn btn-ghost" id="stopCameraBtn" disabled>
              Parar
            </button>
          </div>

          <!-- Auto Capture Toggle -->
          <div class="auto-capture-toggle">
            <div class="toggle-container">
              <span class="toggle-label">Captura Autom√°tica</span>
              <div class="toggle-switch" id="autoCaptureToggle"></div>
            </div>

            <div class="interval-selector">
              <label for="intervalSelect">Intervalo:</label>
              <select id="intervalSelect">
                <option value="3">3 segundos</option>
                <option value="5">5 segundos</option>
                <option value="7">7 segundos</option>
                <option value="10">10 segundos</option>
                <option value="15">15 segundos</option>
                <option value="20">20 segundos</option>
              </select>
            </div>

            <!-- Model Selector -->
            <div class="model-selector-container">
              <div class="model-selector">
                <label for="modelSelect">Modelo IA:</label>
                <select id="modelSelect">
                  <option value="Facenet" selected>Facenet (Padr√£o)</option>
                  <option value="VGG-Face">VGG-Face</option>
                  <option value="Facenet512">Facenet512</option>
                  <option value="OpenFace">OpenFace</option>
                  <option value="ArcFace">ArcFace</option>
                  <option value="Dlib">Dlib</option>
                </select>
              </div>
            </div>

            <p class="toggle-description">
              Ative para capturar e analisar automaticamente no intervalo
              escolhido
            </p>
          </div>
        </div>

        <!-- Results Sidebar -->
        <div class="results-card">
          <div class="results-header">
            <h2 class="results-title">Resultados</h2>
            <p class="results-subtitle">√öltimas emo√ß√µes detectadas</p>
          </div>

          <!-- Campo para mensagem da regra -->
          <div
            id="ruleMessageContainer"
            class="rule-message-container"
            style="display: none"
          >
            <div class="rule-message-box">
              <div class="rule-message-icon">üí¨</div>
              <div class="rule-message-content">
                <div class="rule-message-label">Mensagem da Regra</div>
                <div id="ruleMessageText" class="rule-message-text"></div>
              </div>
            </div>
          </div>

          <div id="resultsContainer">
            <div class="empty-state">
              <div class="empty-icon">üìä</div>
              <p>Nenhuma an√°lise ainda</p>
            </div>
          </div>
        </div>
      </div>

      <!-- User Info -->
      <div class="user-card">
        <div class="user-header">
          <div class="user-avatar">U</div>
          <div class="user-info">
            <h3 id="userName">Carregando...</h3>
            <p id="userRole">Cuidador</p>
          </div>
        </div>

        <div class="user-stats">
          <div class="stat-item">
            <div class="stat-value" id="totalAnalysis">0</div>
            <div class="stat-label">An√°lises Hoje</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="alertsCount">0</div>
            <div class="stat-label">Alertas</div>
          </div>
        </div>
      </div>
    </main>

    <script>
      const API_URL = "http://localhost:5240/api";
      const FACIAL_API_URL = "http://localhost:5236/api";
      const DEEPFACE_URL = "http://localhost:5000";

      let stream = null;
      let analysisInterval = null;
      let autoCaptureEnabled = false;

      // Get selected interval in milliseconds
      function getIntervalMs() {
        const seconds = parseInt(
          document.getElementById("intervalSelect").value
        );
        return seconds * 1000;
      }

      // Auto capture toggle
      document
        .getElementById("autoCaptureToggle")
        .addEventListener("click", function () {
          autoCaptureEnabled = !autoCaptureEnabled;
          this.classList.toggle("active", autoCaptureEnabled);

          if (autoCaptureEnabled && stream) {
            const interval = getIntervalMs();
            analysisInterval = setInterval(captureAndAnalyze, interval);
          } else if (analysisInterval) {
            clearInterval(analysisInterval);
            analysisInterval = null;
          }
        });

      // Update interval when changed
      document
        .getElementById("intervalSelect")
        .addEventListener("change", function () {
          if (autoCaptureEnabled && stream) {
            // Restart interval with new duration
            if (analysisInterval) {
              clearInterval(analysisInterval);
            }
            const interval = getIntervalMs();
            analysisInterval = setInterval(captureAndAnalyze, interval);
          }
        });

      // Load user data
      async function loadUserData() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "login.html";
          return;
        }

        try {
          const response = await fetch(`${API_URL}/auth/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!response.ok) throw new Error("Failed to load user");

          const user = await response.json();

          // Salvar nome do paciente para uso posterior
          if (user.patientName) {
            localStorage.setItem("patientName", user.patientName);
          }

          document.getElementById("userName").textContent = `Paciente: ${
            user.patientName || "N√£o informado"
          }`;
          document.getElementById("userRole").textContent = `Cuidador: ${
            user.name || "N√£o informado"
          }`;
          document.querySelector(".user-avatar").textContent =
            (user.patientName || "P")[0].toUpperCase();
        } catch (error) {
          console.error("Error loading user:", error);
        }
      }

      // Load available models
      async function loadModels() {
        try {
          const token = localStorage.getItem("token");
          if (!token) return;

          const response = await fetch(
            `${FACIAL_API_URL}/FacialAnalysis/models`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );

          if (response.ok) {
            const data = await response.json();
            const select = document.getElementById("modelSelect");
            if (select && data.modelos_disponiveis) {
              select.innerHTML = ""; // Clear existing
              data.modelos_disponiveis.forEach((model) => {
                const option = document.createElement("option");
                option.value = model.nome;
                option.textContent = `${model.nome} (${model.velocidade})`;
                if (model.recomendado) option.selected = true;
                select.appendChild(option);
              });
            }
          }
        } catch (error) {
          console.error("Error loading models:", error);
        }
      }

      // Camera functions
      document
        .getElementById("startCameraBtn")
        .addEventListener("click", async () => {
          try {
            // Verificar se j√° h√° uma stream ativa
            if (stream) {
              stream.getTracks().forEach((track) => track.stop());
            }

            stream = await navigator.mediaDevices.getUserMedia({
              video: {
                width: { ideal: 640, min: 320 },
                height: { ideal: 480, min: 240 },
                facingMode: "user",
              },
            });

            const video = document.getElementById("videoElement");
            video.srcObject = stream;

            // Aguardar o v√≠deo carregar e reproduzir
            await new Promise((resolve) => {
              video.onloadedmetadata = () => {
                video
                  .play()
                  .then(resolve)
                  .catch(() => resolve());
              };
            });

            document.getElementById("videoOverlay").style.display = "none";

            document.getElementById("startCameraBtn").disabled = true;
            document.getElementById("captureFaceBtn").disabled = false;
            document.getElementById("stopCameraBtn").disabled = false;

            // Start auto-capture if enabled
            if (autoCaptureEnabled) {
              const interval = getIntervalMs();
              analysisInterval = setInterval(captureAndAnalyze, interval);
            }
          } catch (error) {
            alert("Erro ao acessar c√¢mera: " + error.message);
          }
        });

      document.getElementById("stopCameraBtn").addEventListener("click", () => {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        if (analysisInterval) {
          clearInterval(analysisInterval);
        }

        document.getElementById("videoOverlay").style.display = "flex";
        document.getElementById("startCameraBtn").disabled = false;
        document.getElementById("captureFaceBtn").disabled = true;
        document.getElementById("stopCameraBtn").disabled = true;
      });

      document
        .getElementById("captureFaceBtn")
        .addEventListener("click", captureAndAnalyze);

      async function captureAndAnalyze() {
        const video = document.getElementById("videoElement");
        if (!video.videoWidth || !video.videoHeight) {
          alert("C√¢mera n√£o est√° pronta. Aguarde o v√≠deo carregar.");
          return;
        }

        // Verificar se h√° um stream ativo
        if (!stream || !stream.active) {
          alert("C√¢mera n√£o est√° ativa. Clique em 'Iniciar C√¢mera' primeiro.");
          return;
        }

        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        canvas.toBlob(
          async (blob) => {
            if (!blob) {
              alert("Falha ao capturar imagem da c√¢mera. Tente novamente.");
              return;
            }

            if (blob.size === 0) {
              alert("Imagem capturada est√° vazia. Verifique a c√¢mera.");
              return;
            }

            const formData = new FormData();
            formData.append("file", blob, "capture.jpg");

            // Get selected model
            const modelSelect = document.getElementById("modelSelect");
            const selectedModel = modelSelect ? modelSelect.value : "Facenet";
            formData.append("model", selectedModel);
            formData.append("actions", "emotion,age,gender");

            try {
              const token = localStorage.getItem("token");
              if (!token) {
                alert("Token n√£o encontrado. Fa√ßa login novamente.");
                window.location.href = "login.html";
                return;
              }

              // Mostrar indicador de carregamento
              const captureBtn = document.getElementById("captureFaceBtn");
              const originalText = captureBtn.textContent;
              captureBtn.textContent = "Analisando...";
              captureBtn.disabled = true;

              const response = await fetch(
                `${FACIAL_API_URL}/FacialAnalysis/analyze`,
                {
                  method: "POST",
                  body: formData,
                  headers: {
                    Authorization: `Bearer ${token}`,
                  },
                }
              );

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro HTTP: ${response.status} - ${errorText}`);
              }

              const data = await response.json();
              displayResults(data);
              saveToHistory(data);

              // Restaurar bot√£o
              captureBtn.textContent = originalText;
              captureBtn.disabled = false;
            } catch (error) {
              alert("Erro ao analisar: " + error.message);

              // Restaurar bot√£o em caso de erro
              const captureBtn = document.getElementById("captureFaceBtn");
              captureBtn.textContent = "Capturar";
              captureBtn.disabled = false;
            }
          },
          "image/jpeg",
          0.95
        );
      }

      // Fun√ß√£o para mostrar alertas
      function showAlert(message, type = "info") {
        // Remover alertas existentes
        const existingAlerts = document.querySelectorAll(".alert-message");
        existingAlerts.forEach((alert) => alert.remove());

        // Criar novo alerta
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert-message alert-${type}`;
        alertDiv.innerHTML = `
          <div class="alert-content">
            <span class="alert-icon">${type === "warning" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è"}</span>
            <span class="alert-text">${message}</span>
            <button class="alert-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;

        // Adicionar estilos inline se n√£o existirem
        if (!document.querySelector(".alert-styles")) {
          const styles = document.createElement("style");
          styles.className = "alert-styles";
          styles.textContent = `
            .alert-message {
              position: fixed;
              top: 20px;
              right: 20px;
              z-index: 1000;
              min-width: 300px;
              max-width: 500px;
            }
            .alert-content {
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 15px 20px;
              border-radius: 8px;
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
              font-weight: 500;
            }
            .alert-warning .alert-content {
              background: #fef3c7;
              color: #92400e;
              border: 1px solid #f59e0b;
            }
            .alert-info .alert-content {
              background: #dbeafe;
              color: #1e40af;
              border: 1px solid #3b82f6;
            }
            .alert-close {
              background: none;
              border: none;
              font-size: 20px;
              cursor: pointer;
              opacity: 0.7;
              margin-left: auto;
            }
            .alert-close:hover {
              opacity: 1;
            }
          `;
          document.head.appendChild(styles);
        }

        document.body.appendChild(alertDiv);

        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
          if (alertDiv.parentElement) {
            alertDiv.remove();
          }
        }, 5000);
      }

      function displayResults(data) {
        const container = document.getElementById("resultsContainer");

        // Verificar se h√° mensagem de alerta da regra
        const suggestedMessage =
          data.mensagem || data.mensagem_sugerida || data.suggestedMessage;
        const ruleMessageContainer = document.getElementById(
          "ruleMessageContainer"
        );
        const ruleMessageText = document.getElementById("ruleMessageText");

        if (suggestedMessage) {
          // Mostrar mensagem da regra no campo dedicado
          ruleMessageText.textContent = suggestedMessage;
          ruleMessageContainer.style.display = "block";
        } else {
          // Esconder campo se n√£o h√° mensagem
          ruleMessageContainer.style.display = "none";
        }

        const analise = data.analise || data;
        const emotions =
          analise.emocoes || analise.emotions || data.emocoes || {};
        const dominant =
          analise.emocao_dominante ||
          analise.emocao ||
          data.emocao ||
          "neutral";

        const sortedEmotions = Object.entries(emotions)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 5);

        if (sortedEmotions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <p>Nenhuma emo√ß√£o detectada</p>
            </div>
          `;
          return;
        }

        container.innerHTML = sortedEmotions
          .map(
            ([emotion, percentage]) => `
        <div class="result-item">
          <div class="result-header">
            <span class="result-emotion">${translateEmotion(emotion)}</span>
            <span class="result-percentage">${percentage.toFixed(1)}%</span>
          </div>
          <div class="result-message ${emotion === dominant ? "success" : ""}">
            ${emotion === dominant ? "‚úì Emo√ß√£o dominante" : "Detectado"}
          </div>
        </div>
      `
          )
          .join("");

        // Update stats
        const current = parseInt(
          document.getElementById("totalAnalysis").textContent
        );
        document.getElementById("totalAnalysis").textContent = current + 1;
      }

      function translateEmotion(emotion) {
        const translations = {
          happy: "Feliz",
          sad: "Triste",
          angry: "Raiva",
          surprise: "Surpreso",
          fear: "Medo",
          disgust: "Desgosto",
          neutral: "Neutro",
        };
        return translations[emotion] || emotion;
      }

      async function saveToHistory(data) {
        const token = localStorage.getItem("token");
        if (!token) return;

        try {
          // Tentar pegar do localStorage primeiro (mais confi√°vel)
          let userId = localStorage.getItem("userId");

          // Se n√£o tiver no localStorage, tentar decodificar do token (fallback)
          if (!userId) {
            const tokenPayload = JSON.parse(atob(token.split(".")[1]));
            // Priorizar claims que sabemos que s√£o num√©ricos: userId, nameid (se for num√©rico)
            // Evitar 'sub' se for email
            userId = tokenPayload.userId || tokenPayload.nameid;

            // Se ainda n√£o achou ou se pegou algo que n√£o parece n√∫mero, tentar o claim longo
            if (!userId) {
              userId =
                tokenPayload[
                  "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"
                ];
            }
          }

          userId = parseInt(userId);

          if (isNaN(userId)) {
            console.error(
              "[DEBUG] N√£o foi poss√≠vel identificar o UserId para salvar hist√≥rico"
            );
            return;
          }

          // Ajustar para a estrutura da API C#
          const analise = data.analise || data;
          const emotions =
            analise.emocoes || analise.emotions || data.emocoes || {};
          const dominant =
            analise.emocao_dominante ||
            analise.emocao ||
            data.emocao ||
            "neutral";

          // Recuperar nome do paciente do localStorage
          const patientName = localStorage.getItem("patientName") || "Paciente";

          const payload = {
            cuidadorId: userId,
            patientName: patientName,
            emotionsDetected: emotions,
            dominantEmotion: dominant,
            timestamp: new Date().toISOString(),
          };

          console.log("[DEBUG] Salvando no hist√≥rico:", payload);

          const response = await fetch(`${API_URL}/history/cuidador-emotion`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("[DEBUG] Erro ao salvar hist√≥rico:", errorText);
          } else {
            const result = await response.json();
            console.log("[DEBUG] Hist√≥rico salvo com sucesso:", result);

            // Se houver mensagem de regra, atualizar o UI
            if (result.suggestedMessage) {
              const ruleMessageContainer = document.getElementById(
                "ruleMessageContainer"
              );
              const ruleMessageText =
                document.getElementById("ruleMessageText");
              ruleMessageText.textContent = result.suggestedMessage;
              ruleMessageContainer.style.display = "block";
            }
          }
        } catch (error) {
          // Silently fail for history saving
        }
      }

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem("token");
        window.location.href = "login.html";
      });

      // Initialize
      loadUserData();
      loadModels();
    </script>
  </body>
</html>
